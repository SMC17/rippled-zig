name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1
    
    - name: Build
      run: zig build
    
    - name: Run Tests
      run: zig build test
    
    - name: Check Formatting
      run: zig fmt --check src/ tests/

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Build WASM targets
      run: zig build wasm

    - name: Verify WASM artifacts
      run: |
        test -f zig-out/wasm/protocol_kernel.wasm
        test -f zig-out/wasm/hook_template.wasm

    - name: Hook WASM export smoke check
      run: |
        chmod +x scripts/wasm/check_hook_exports.sh
        scripts/wasm/check_hook_exports.sh zig-out/wasm/hook_template.wasm artifacts/wasm-hook-export-check

  release-provenance:
    name: Release checksum provenance
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1
      - name: Build release
        run: zig build -Doptimize=ReleaseSafe && zig build wasm
      - name: Generate provenance
        run: |
          mkdir -p zig-out/release
          cp zig-out/bin/rippled-zig zig-out/wasm/*.wasm zig-out/release/
          (cd zig-out/release && sha256sum -b rippled-zig *.wasm > SHA256SUMS)
          echo '{"version":"1.0","checksums":"SHA256SUMS"}' > zig-out/release/PROVENANCE.json
      - name: Install cosign
        if: secrets.COSIGN_PRIVATE_KEY != ''
        uses: sigstore/cosign-installer@v3
      - name: Sign release with cosign
        if: secrets.COSIGN_PRIVATE_KEY != ''
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        run: cosign sign-blob zig-out/release/SHA256SUMS --output-signature zig-out/release/SHA256SUMS.sig
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}
          path: zig-out/release

  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.15.1

    - name: Format Check
      run: zig fmt --check .

    - name: Build Check
      run: zig build --summary all
